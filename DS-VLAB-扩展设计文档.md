# DS-VLAB 扩展设计文档

## 一、项目背景与目标
DS-VLAB 是面向《计算机组成原理》的虚拟实验平台，已有基础器件库与电路编辑功能，但当前存在 AI 理解能力弱、元件规格固定、交互体验欠缺等问题。本次扩展目标是在保留已有思路的基础上：为元件补充 AI 可感知的描述层，扩展关键器件至 8 位规格、修复可感知交互问题、引入文字标注能力，并打造 AI 编程桥接流程，支撑课堂展示与自动化生成。

## 二、AI 编程桥接层总览
### 2.1 Circuit-DSL 描述
Circuit-DSL 以声明式语句串联元件、引脚、连线、参数、布局与文字，形成 AI 与平台之间的“可读可写”语义桥。语法片段包括：
- `DEVICE <类型> [参数]`：声明元件，附带规格、实例名与初始位置。
- `PIN <实例>.<引脚名>`：定义输入输出方向与位宽。
- `WIRE <源> -> <目标>`：描述连线关系，同步支持总线展开与自动吸附。
- `LABEL <文本> POS=<x,y> [FONT=<>]`：标注任意位置文字。
- `MODE <实例> := <操作>`：为仿真器件设置运行模式或初始化状态。

示例片段：
```
DEVICE 74LS181_8 DATAWIDTH=8 NAME=ALU1 POS=120,60
PIN ALU1.A[7..0] INPUT
PIN ALU1.B[7..0] INPUT
PIN ALU1.FUNC SELECT MODE
WIRE ALU1.OUT[7..0] -> BUS_OUT[7..0]
LABEL "ALU 8 位结果" POS=260,150 FONT=16
MODE ALU1 := ADD
```
DSL 约束了 AI 输出的格式，使得后续翻译脚本只需关注语义映射，无需直接操作内部 DOM。

### 2.2 翻译脚本层（AST → DS-VLAB）
翻译脚本建议采用 Node.js/TypeScript 实现，流程为：
1. CI/CD 接受 DSL 文本，逐行词法分析，构造 AST 节点（Device/Pin/Wire/Label/Mode）。
2. 每个节点与现有元件注册表匹配，如发现 `74LS181_8`，生成对应 JSON 描述。
3. 连线节点转换为平台 `connections`，考虑总线位宽与吸附权重。
4. 文字节点附加到画布 `entities`，含字体、背景透明度等。
5. 生成的 JSON 以事件或 RPC 方式推送给编辑器运行时，实现布局与仿真初始化。

该脚本应包含日志、异常兜底与参数校验，确保外部 DSL 恶意或错误时不会破坏原有项目状态。

### 2.3 平台执行层配合
- 编辑器接收桥接数据后：自动创建元件实体、引脚附着、连线绘制、文字渲染，并触发仿真引擎重载。
- 若 AI 提供布局属性，执行层需支持对齐与吸附策略；若仅给出逻辑关系，可采用默认网格排布。
- 仿真引擎在节点初始化后即可运行，配置 `MODE`、输入值等，使示意电路可直接验证。

## 三、核心交付内容
### 3.1 新增可仿真元件方案
#### 8 位 ALU（基于 74LS181 扩展）
- 将原 4 位查找表逻辑复用为双组 4 位运算单元，输出使用一级组合逻辑实现进位与借位级联。
- 引脚：A[7..0]/B[7..0]、S[3..0]（功能选择）、M、CI、P/G、Z（零标志）、V（溢出），共 8 位。
- 界面：保留现有图标风格，加粗连接，提供实时状态显示（如进位灯）。
- 仿真：新增 `alu8.run(mode, inputs)`，通过输入切片与查找表决定结果，并同步更新标志位。
- 注册：在器件库 JSON 中新增 `74LS181_8` 元数据，并同步 DSL 映射。

#### 8 位可逆计数器（组合式寄存器）
- 支持同步加载、清零、方向（可逆）、时钟抽象，计数范围 0~255。
- 内部线路使用两个 4 位计数器级联，提供 `LOAD`、`CLR`、`DIR`、`EN` 引脚，输出 Q[7..0]。
- 仿真逻辑与 `clk` 事件绑定，可在仿真模式下提供步进/连续运行。
- UI：添加方向箭头与大小端指示，无需额外画布。

### 3.2 已有元件优化
#### 74LS181 8 位扩展计划
- 左右拼接两组 74LS181 4 位计算单元，外层统一 `S` 信号，并通过共享进位链 `CI/CO`。
- 保留原始控制信号（M、S0~S3、Cn），新增 `S1`/`S0` 复合控制 8 位操作。
- 逻辑验证：设计单元测试电路（如加法/减法/逻辑运算），读取内部旗标，确保与 4 位版本语义一致。
- 界面：将两个单元按水平排列显示，添加统一标识与 8 位输入输出条，连线可在 DSL 中直接引用 `ALU_OUT[7..0]`。

#### 74LS163 8 位扩展计划
- 在同一封装中串联两个 4 位计数器，确保 `CLR`、`LOAD`、`ENT/ENP` 信号共用；`Q[7..0]` 输出与 `TC` 进位互斥。
- 计数器链路在仿真中保持同步，添加 `DIR` 控制时可模拟可逆计数行为。
- 为保持同步清零/并行加载，新增状态机确保两个 4 位阶梯同时失效。

### 3.3 交互与 UI 修复
- 统一默认连线颜色与粗细，通过主题配置控制，实现高级/低视差模式。
- 清空/重置操作弹出中文确认提示，避免误操作，且在 DSL 模式下可强制清空。
- 改善连线热区与吸附算法，使旋转/镜像后仍可顺畅接入；修复部分器件拖拽失效的问题。

### 3.4 加分项：文字标注功能
- 新增 `TEXT` 实体，可绑定画布坐标或依附于元件，支持中文字体、字号、填充透明度与边框样式。
- 文本实体需支持拖拽、编辑与分组，并在保存/加载 JSON 时保持 `content`、`fontSize`、`background` 等属性。
- DSL 直接生成 `LABEL` 节点，桥接层将其转换为平台 `annotations` 模块。

## 四、AI 生成流程与验证
1. AI 输出 Circuit-DSL（示例见 2.1），脚本层解析为 AST。
2. 结合元件库、引脚集，翻译脚本生成 DS-VLAB JSON（含实体、连线、文字、模式），并通过事件派发到编辑器。
3. 编辑器自动生成画布图形，仿真引擎读取 `MODE` 配置，执行 8 位 ALU、计数器等逻辑。
4. 用户可立即运行并观察输出，若异常可以写入 `ERROR` 节点回到 DSL 层。

### 示例 DSL 输入
```
DEVICE 74LS181_8 NAME=ALU1 POS=100,80
DEVICE 74LS163_8 NAME=CTR_POS POS=40,180
WIRE ALU1.OUT[7..0] -> BUS_OUT[7..0]
WIRE CTR_POS.Q[7..0] -> ALU1.B[7..0]
LABEL "加减法计数器" POS=80,260 FONT=20
MODE ALU1 := ADD
MODE CTR_POS := UP
```
这个输入会触发脚本生成完整电路，包括电源、负载与文字注释，并可以立即仿真。

## 五、课堂展示与验收要点
1. 先展示扩展元件（8 位 ALU/计数器），并展示仿真效验结果。
2. 演示修复后的交互，包括统一连线颜色与清空确认框、拖拽稳定性。
3. 演示文字标注功能、保存/加载、与元件绑定的效果。
4. 最后展示 AI 桥接层，实时写入 DSL，自动生成电路，运行仿真，突出立即性与稳定性。

## 六、实施节奏与质量保障
- 组件拆分：先完成 DSL 与翻译脚本、再同步 UI 与仿真扩展、最后整合文字标注与 Bug 修复。
- 验证：编写单元测试覆盖 ALU 逻辑与计数器状态，使用现有电路演示多种模式。
- 文档：每个新增组件需补齐接口注释与使用示例，DSL 规范形成最终手册。
- 回归：在完成后执行现有示例`index.html`场景，确保兼容度。